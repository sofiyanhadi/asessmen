<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Ujian Esai AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    #teacher-settings-btn {
      position: absolute; top: 1rem; right: 1rem;
      font-size: 1.3rem; cursor: pointer;
      background: transparent; border: none;
      z-index: 100;
    }
    .modal-backdrop {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.5); z-index: 50;
    }
    .modal {
      display: none; position: fixed; top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      z-index: 60; width: 95%; max-width: 650px;
      background: white; border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .tab-active {
      border-bottom: 3px solid #2563eb;
      color: #2563eb; font-weight: 700;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-6 md:p-8 relative overflow-hidden">
    <button id="teacher-settings-btn" title="Pengaturan Guru">‚öôÔ∏è</button>
    <div class="text-center mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Ujian Esai Otomatis</h1>
      <p class="text-gray-500 mt-1">Ditenagai oleh AI untuk Koreksi Cerdas</p>
    </div>

    <!-- Start screen -->
    <div id="start-screen">
      <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6">
        <p class="font-bold">Selamat Datang!</p>
        <div class="text-sm">
          <p><strong>Mata Pelajaran:</strong> <span id="exam-subject-display">-</span></p>
          <p><strong>Materi Ujian:</strong> <span id="exam-material-display-2">-</span></p>
        </div>
      </div>
      <div class="space-y-4">
        <input id="student-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Nama Lengkap Anda">
        <input id="student-class" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Kelas (e.g., 7A)">
        <button id="start-quiz-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">Mulai Ujian</button>
      </div>
      <div id="start-error" class="text-red-500 mt-2 text-center"></div>
    </div>
  </div>

  <!-- Modal PIN -->
  <div id="pin-modal" class="modal">
    <div class="p-6 text-center">
      <h2 class="text-xl font-bold mb-4 text-gray-800">üîí Masukkan PIN Guru</h2>
      <input id="pin-input" type="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 text-center" placeholder="Masukkan PIN">
      <div class="flex justify-center space-x-2">
        <button id="pin-submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Masuk</button>
        <button id="pin-cancel" class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">Batal</button>
      </div>
    </div>
  </div>

  <!-- Modal Guru -->
  <div id="teacher-modal" class="modal">
    <div class="p-6">
      <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">‚öôÔ∏è Panel Guru</h2>
      <div class="flex border-b mb-4">
        <button class="tab-btn flex-1 py-2 text-center font-semibold border-b-2 border-transparent hover:text-blue-600" data-tab="tab-settings">Pengaturan</button>
        <button class="tab-btn flex-1 py-2 text-center font-semibold border-b-2 border-transparent hover:text-blue-600" data-tab="tab-generator">Generator Soal</button>
        <button class="tab-btn flex-1 py-2 text-center font-semibold border-b-2 border-transparent hover:text-blue-600" data-tab="tab-link">Generator Link</button>
      </div>

      <!-- Tab Pengaturan -->
      <div id="tab-settings" class="tab-content">
        <label class="block text-sm font-semibold text-gray-700 mb-1">URL Spreadsheet Google</label>
        <input id="sheet-url-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-3" placeholder="https://docs.google.com/spreadsheets/d/...">
        <label class="block text-sm font-semibold text-gray-700 mb-1">URL Apps Script (Web App)</label>
        <input id="apps-script-url-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-3" placeholder="https://script.google.com/macros/s/.../exec">
        <label class="block text-sm font-semibold text-gray-700 mb-1">PIN Guru (ubah jika perlu)</label>
        <input id="teacher-pin-input" type="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-3" placeholder="PIN Guru">
        <button id="save-settings-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Simpan Pengaturan</button>
      </div>

      <!-- Tab Generator Soal -->
      <div id="tab-generator" class="tab-content hidden">
        <div class="space-y-2">
          <input id="q-mapel" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Mata Pelajaran">
          <input id="q-materi" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Materi">
          <input id="q-jenis" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Jenis Soal (Esai/Pilgan)">
          <textarea id="q-soal" class="w-full px-3 py-2 border border-gray-300 rounded-lg h-24" placeholder="Tulis Soal"></textarea>
          <textarea id="q-kunci" class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20" placeholder="Tulis Kunci Jawaban"></textarea>
          <button id="send-question-btn" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">Kirim ke Spreadsheet</button>
        </div>
      </div>

      <!-- Tab Generator Link -->
      <div id="tab-link" class="tab-content hidden">
        <div class="space-y-3">
          <input id="link-mapel" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Mata Pelajaran">
          <input id="link-materi" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Materi">
          <button id="generate-link-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Buat Link</button>
          <div id="generated-link" class="text-sm text-center text-gray-700 mt-3 break-all"></div>
        </div>
      </div>

      <div class="mt-6 text-center">
        <button id="close-settings-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Tutup Pengaturan</button>
      </div>
    </div>
  </div>

  <div id="modal-backdrop" class="modal-backdrop"></div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    let settings = { sheetUrl: "", appsScriptUrl: "", teacherPin: "" };
    const teacherBtn = document.getElementById("teacher-settings-btn");
    const teacherModal = document.getElementById("teacher-modal");
    const pinModal = document.getElementById("pin-modal");
    const modalBackdrop = document.getElementById("modal-backdrop");
    const tabBtns = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");

    // --- modal switching
    function switchTab(id){
      tabBtns.forEach(b=>b.classList.remove("tab-active"));
      tabContents.forEach(t=>t.classList.add("hidden"));
      document.querySelector(`[data-tab='${id}']`).classList.add("tab-active");
      document.getElementById(id).classList.remove("hidden");
    }

    // --- open/close modal
    function openTeacherModal(){
      teacherModal.style.display="block"; modalBackdrop.style.display="block"; switchTab("tab-settings");
    }
    function closeTeacherModal(){
      teacherModal.style.display="none"; pinModal.style.display="none"; modalBackdrop.style.display="none";
    }

    // --- PIN Modal
    teacherBtn.addEventListener("click",()=>{
      const savedPin = localStorage.getItem("teacherPin");
      if(!savedPin){ openTeacherModal(); return; }
      pinModal.style.display="block"; modalBackdrop.style.display="block";
      document.getElementById("pin-input").value="";
      document.getElementById("pin-input").focus();
    });

    document.getElementById("pin-submit").addEventListener("click",()=>{
      const inputPin=document.getElementById("pin-input").value;
      const savedPin=localStorage.getItem("teacherPin");
      if(savedPin===btoa(inputPin)){ pinModal.style.display="none"; openTeacherModal(); }
      else alert("PIN salah!");
    });
    document.getElementById("pin-cancel").addEventListener("click",closeTeacherModal);
    document.getElementById("close-settings-btn").addEventListener("click",closeTeacherModal);
    modalBackdrop.addEventListener("click",closeTeacherModal);

    tabBtns.forEach(btn=>btn.addEventListener("click",()=>switchTab(btn.dataset.tab)));

    // --- Save settings
    document.getElementById("save-settings-btn").addEventListener("click",()=>{
      const sheet=document.getElementById("sheet-url-input").value.trim();
      const app=document.getElementById("apps-script-url-input").value.trim();
      const pin=document.getElementById("teacher-pin-input").value.trim();
      if(!sheet||!app){alert("Isi URL terlebih dahulu.");return;}
      localStorage.setItem("sheetUrl",sheet);
      localStorage.setItem("appsScriptUrl",app);
      settings.sheetUrl=sheet; settings.appsScriptUrl=app;
      if(pin){ localStorage.setItem("teacherPin",btoa(pin)); settings.teacherPin=pin; }
      alert("‚úÖ Pengaturan disimpan!");
      closeTeacherModal();
    });

    // --- Generator soal
    document.getElementById("send-question-btn").addEventListener("click",async()=>{
      const data={
        action:"addQuestion",
        mapel:document.getElementById("q-mapel").value,
        materi:document.getElementById("q-materi").value,
        jenis:document.getElementById("q-jenis").value,
        question:document.getElementById("q-soal").value,
        answer:document.getElementById("q-kunci").value
      };
      const app=localStorage.getItem("appsScriptUrl");
      if(!app){alert("URL Apps Script belum diatur.");return;}
      const res=await fetch(app,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});
      const r=await res.json(); alert(r.message||"Soal berhasil dikirim!");
    });

    // --- Generator link
    document.getElementById("generate-link-btn").addEventListener("click",()=>{
      const m=document.getElementById("link-mapel").value.trim();
      const mat=document.getElementById("link-materi").value.trim();
      const base=window.location.origin+window.location.pathname;
      const link=`${base}?mapel=${encodeURIComponent(m)}&materi=${encodeURIComponent(mat)}`;
      document.getElementById("generated-link").innerHTML=`<a href='${link}' target='_blank' class='text-blue-600 underline'>${link}</a>`;
    });

    // --- Load saved
    const sSheet=localStorage.getItem("sheetUrl");
    const sApp=localStorage.getItem("appsScriptUrl");
    if(sSheet) settings.sheetUrl=sSheet;
    if(sApp) settings.appsScriptUrl=sApp;
  });
  </script>
</body>
</html>
